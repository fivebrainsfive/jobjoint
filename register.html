<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register - JobJoint</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  <script src="firebase.js"></script>
</head>
<body>
  <header><h1>Register - JobJoint</h1></header>

  <div class="container">
    <h2>Create Account (2-Step Verification)</h2>
    <p>Step 1: Enter details and verify your phone number</p>

    <input type="text" id="name" placeholder="Full Name" required>
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Password" required>
    <select id="role">
      <option value="worker">Rural Worker</option>
      <option value="graduate">Graduate Helper</option>
    </select>
    <input type="text" id="phone" placeholder="Enter phone number" required>

    <div id="recaptcha-container"></div>
    <button onclick="sendOTP()">Send OTP</button>

    <input type="text" id="otp" placeholder="Enter OTP here">
    <button onclick="verifyOTP()">Verify OTP & Register</button>
  </div>

  <script>
    let confirmationResult;

    // Initialize reCAPTCHA
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
      'size': 'normal',
      'callback': () => { console.log('reCAPTCHA solved'); }
    });

    // Send OTP function
    function sendOTP() {
      let phone = document.getElementById('phone').value.trim();

      // Auto-add +91 if missing
      if (!phone.startsWith("+")) {
        phone = "+91" + phone;
      }

      // Validate 10 digit number after country code
      const phoneDigits = phone.replace(/\D/g,'').slice(2); // remove +91
      if (phoneDigits.length !== 10) {
        alert("Please enter a valid 10-digit phone number.");
        return;
      }

      firebase.auth().signInWithPhoneNumber(phone, window.recaptchaVerifier)
        .then(result => {
          confirmationResult = result;
          alert("OTP sent! Check your phone.");
        })
        .catch(err => alert("Error sending OTP: " + err.message));
    }

    // Verify OTP and create account
    function verifyOTP() {
      const otp = document.getElementById('otp').value;
      if (!otp) { alert("Enter OTP"); return; }

      confirmationResult.confirm(otp)
        .then(() => { 
          alert("Phone verified ✅"); 
          createAccount(); 
        })
        .catch(() => alert("Invalid OTP ❌"));
    }

    // Create user with Email + Password
    function createAccount() {
      const nameVal = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      const role = document.getElementById('role').value;
      let phone = document.getElementById('phone').value.trim();
      if (!phone.startsWith("+")) phone = "+91" + phone;

      auth.createUserWithEmailAndPassword(email, pass)
        .then(userCred => {
          const user = userCred.user;

          // Send email verification
          user.sendEmailVerification()
            .then(() => {
              db.collection("users").doc(user.uid).set({
                name: nameVal,
                email: email,
                phone: phone,
                role: role,
                verifiedPhone: true,
                verifiedEmail: false
              }).then(() => {
                alert("Email verification sent! Check inbox. Registration complete.");
                window.location.href = "login.html";
              });
            })
            .catch(err => alert("Error sending verification email: " + err.message));
        })
        .catch(err => alert("Error creating account: " + err.message));
    }
  </script>
</body>
</html>
